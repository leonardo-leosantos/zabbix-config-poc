networks:
  zabbix-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

services:
  postgres_zabbix:
    container_name: postgres_zabbix
    image: postgres:15
    networks:
      - zabbix-network
    environment:
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix
      - POSTGRES_DB=zabbix
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
  zabbix-server:
    container_name: zabbix-server
    build: ./docker/zabbix-server-odbc
    image: zabbix-server-odbc:local
    networks:
      - zabbix-network
    links:
      - postgres_zabbix
    restart: always
    ports:
      - "10051:10051"
    volumes:
      - ./zabbix/alertscripts:/usr/lib/zabbix/alertscripts
    environment:
      - DB_SERVER_HOST=postgres_zabbix
      - DB_SERVER_PORT=5432
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix
      - POSTGRES_DB=zabbix
    depends_on:
      - postgres_zabbix
  zabbix-web:
    container_name: zabbix-web-frontend
    image: zabbix/zabbix-web-apache-pgsql:latest
    networks:
      - zabbix-network
    links:
      - postgres_zabbix
    restart: always
    ports:
      - "80:8080"   # Apache na imagem escuta em 8080; 443:8443 para HTTPS
      - "443:8443"
    volumes:
      - ./docker/zabbix-web-status/status.conf:/etc/apache2/conf.d/status.conf:ro
    environment:
      - DB_SERVER_HOST=postgres_zabbix
      - DB_SERVER_PORT=5432
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix
      - POSTGRES_DB=zabbix
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
    depends_on:
      - postgres_zabbix
  zabbix-agent:
    container_name: zabbix-agent
    image: zabbix/zabbix-agent2:latest
    networks:
      zabbix-network:
        ipv4_address: 172.28.0.10
    restart: always
    environment:
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_HOSTNAME=Zabbix server
    depends_on:
      - zabbix-server
  
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    networks:
      - zabbix-network
    ports:
      - "3000:3000"
    volumes:
      - ./grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_INSTALL_PLUGINS=alexanderzobnin-zabbix-app
    restart: unless-stopped
    depends_on:
      - zabbix-web

  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    networks:
      - zabbix-network
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus_data:/prometheus
    restart: unless-stopped
    depends_on:
      - node-exporter
      - cadvisor

  node-exporter:
    container_name: node-exporter
    image: prom/node-exporter:latest
    networks:
      - zabbix-network
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: unless-stopped

  cadvisor:
    container_name: cadvisor
    image: gcr.io/cadvisor/cadvisor:latest
    networks:
      - zabbix-network
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    restart: unless-stopped

  apache-exporter:
    container_name: apache-exporter
    image: quay.io/lusitaniae/apache-exporter:latest
    networks:
      - zabbix-network
    ports:
      - "9117:9117"
    command:
      - '--scrape_uri=http://zabbix-web-frontend:8080/server-status?auto'
    restart: unless-stopped
    depends_on:
      - zabbix-web